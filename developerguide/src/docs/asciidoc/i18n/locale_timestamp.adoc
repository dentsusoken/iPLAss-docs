[[locale_timestamp]]
== テナント単位でのロケール、タイムゾーン定義
// #7813

デフォルトのロケール、タイムゾーンはテナント単位で設定ができます。
テナントにロケール、タイムゾーンが設定されていない場合、テナントはシステムのデフォルトロケール、タイムゾーン（javaVMのデフォルト）で動作します。

=== ロケールの設定
ロケールを設定した場合、次のものに影響を与えます。

* 日付の表示形式 +
ロケール単位に日付入力時/出力時のフォーマットが定義されています。
+
----
ja_JP:yyyy/MM/dd
en_US:MM/dd/yyyy
----

* 数値の表示形式 +
ロケール単位に数値入力時/出力時のフォーマットが定義されています。
+
----
ja_JP:小数点が"." 桁数区切りが","
fr_FR:小数点が"," 桁数区切りが" "
----

=== タイムゾーンの設定
タイムゾーン設定をした場合、ローカル時間（テナントに設定されたタイムゾーン）とシステム時間（システムデフォルトのタイムゾーン）を考慮する必要があります。
テナントのタイムゾーン設定とシステムデフォルトのタイムゾーン設定が異なる場合、それぞれの型に対して次のように考えます。

* 日付型（DateProperty、java.sql.Date） +
日付自体はタイムゾーン情報を持ちません。
iPLAss上、現在日付を取得した場合はローカル日付を表すものとします。
java.sql.Dateのlong値としては、1970-01-01 00:00:00からのミリ秒の値ですが、厳密にはその値はUTC時間を表すものではなく、あくまで日付を指し示すための値を表します。
+
.システム：UTC、テナント：Asia/Tokyoの場合
----
2013-12-31 20:00:00Z（UTC時間）での現在日付は2014-01-01（日本時間）
----

* 時間型（TimeProperty、java.sql.Time） +
時間自体はタイムゾーン情報を持ちません。
iPLAss上、現在時刻を取得した場合はローカル時刻を表すものとします。
java.sql.Dateのlong値としては、1970-01-01 00:00:00から1970-01-02 00:00:00未満のミリ秒の値を表します。
+
.システム：UTC、テナント：Asia/Tokyoの場合
----
2013-12-31 20:00:00Z（UTC時間）での現在時刻は05:00:00（日本時間）
----

* 日時型（DateTimeProperty、java.sql.Timestamp） +
日時型はタイムゾーン情報を持ちます。
iPLAss上、現在時刻はテナントのタイムゾーン定義によらず、一意の時刻を指し示します。
java.sql.Timestampのlong値としては、UTC時間を表します。
+
.システム：UTC、テナント：Asia/Tokyoの場合
----
2013-12-31 20:00:00Z（UTC時間）での現在日時は2014-01-01 05:00:00+09:00（=2013-12-31 20:00:00Z）
----

=== 汎用画面の動作

* 日付/時間/日時のフォーマット +
画面上での日付/時間/日時の入力・出力のフォーマットはロケールごとに異なります。
CSV出力もロケールに依存した出力形式となります。
ただし、日付項目をサーバ側（Command）で受け取る際のフォーマットは `yyyyMMddHHmmssSSS` 形式固定とします。

+
基本的に入力フォーマットと出力フォーマットは同一の形式となります。
ただし、 `ja_JP` ロケールのみ既存との整合性を確保するため、日付フォーマットは以下となります。

- 入力フォーマット: yyyyMMdd
- 出力フォーマット: yyyy/MM/dd


* 数値のフォーマット +
画面上での数値の入力・出力のフォーマットはロケールごとに異なります。
ただし、数値フォーマットを画面定義にて明示的に指定した場合は、その指定に従います。
CSV出力は、ロケール非依存の出力形式（小数点は"."）となります。
また、サーバ側（Command）で受け取る際のフォーマットもロケール非依存の固定形式となります。

=== ロケール、タイムゾーン関連API（Java）
ロケール、タイムゾーン設定が影響するapiは以下になります。

* org.iplass.mtp.util.DateUtil +
日付系のユーティリティクラス。
現在日付/時間/日時を取得するメソッドや、テナントのロケール・タイムゾーン設定を反映させたDateFormat・Calendarクラスのインスタンスの取得メソッドを提供。
このクラスを利用しないで生成した、DateFormat、Calendar、現在日付（new Date()等）は、テナントのロケール・タイムゾーンが反映されず、システムデフォルトの設定が適用されている状態なので注意してください。

* org.iplass.mtp.web.template.TemplateUtil +
テンプレートでプレゼンテーションロジックを実装する際のユーティリティ。
以下のメソッドを提供し、それぞれテナントに設定されているロケール・タイムゾーンを取得します。
設定されていない場合はシステムデフォルトの値が返却されます。

- getLocale()
- getTimeZone()

=== EQL
EQL上におけるロケール、タイムゾーンに関する事項は以下になります。

* EQLで提供される関数 +
+
[cols="1,1,2,1", options="header"]
|===
|関数|返却型(javaクラス)|説明|利用例
|CURRENT_DATE()|date型（java.sql.Date）|	現在の（テナントローカルな）日付を取得する|CURRENT_DATE()
|CURRENT_TIME()|time型（java.sql.Time）|	現在の（テナントローカルな）時間を取得する|CURRENT_TIME()
|CURRENT_DATETIME()|datetime型（java.sql.Timestamp）|	現在の（グローバルな、一意な）日時を取得する。
EQL内でこの値を操作する際は、タイムゾーンはシステムのデフォルトとして扱われる。|HOUR (CURRENT_DATETIME () ) : システムデフォルトのタイムゾーンの時が取得される
|LOCALTIME(datetime)|datetime型（java.sql.Timestamp）|	datetimeで渡される日時をテナントに設定されたローカル時間を示す値に変換する|HOUR (LOCALTIME (CURRENT_DATETIME () ) ) : テナントローカルのタイムゾーンの時間を取得
|===

* EQLリテラル文字列（datetime型） +
EQLのdatetime型の文字列表現でタイムゾーンを明示的に指定することができます。
タイムゾーン指定がない場合は、テナントローカルのタイムゾーンとみなされます。
+
.テナントローカル：Asia/Tokyo、システム：UTCとした場合
----
select oid from AEntity
where createDate >= '2010-01-30 00:00:00.000'm
->東京時間"2010-01-30 00:00:00.000"以降のデータを検索

select oid from AEntity
where createDate >= '2010-01-30 00:00:00.000+09:00'm
->UTC時間"2010-01-29 15:00:00.000"以降のデータを検索
　（＝東京時間"2010-01-30 00:00:00.000"）

select oid from AEntity
where createDate >= '2010-01-30 00:00:00.000Z'm
->UTC時間"2010-01-30 00:00:00.000"以降のデータを検索
　（＝東京時間"2010-01-30 09:00:00.000"）
----

* PreparedQueryのバインド変数 +
PreparedQueryを用いてバインドする際のバインド変数を以下のように定義します。
+
[cols="1,2,1,1", options="header"]
|===
|バインド変数|説明|変換例（変換前）|（変換後）
|sysdate|現在日付（時間含まず）の文字列。テナントローカルなタイムゾーンの日付。|	dateProp >= '${sysdate}'|dateProp >= '2013-08-30'd
|systime|現在時刻の文字列。テナントローカルなタイムゾーンの時刻。|timeProp >= '${systime}'|timeProp >= '14:00:00't
|sysdatetime|現在日時の文字列。テナントローカルなタイムゾーンの日時。|	datetimeProp >= '${sysdatetime}'|datetimeProp >= '2013-08-30 14:00:00.000'm
|===

=== WebApi
* SOAPおよび、REST/XML +
日付項目はそれぞれ、XMLSchemaのdate、time、dateTime型として出力されます。
それぞれの値にはタイムゾーンが出力されます。
+
.出力例
----
"2013-08-30+09:00"
"14:00:00+09:00"
"2013-08-30 14:00:00.000000000+09:00"
----

* REST/JSON +
日付項目はそれぞれ、次の固定形式として出力されます。
+
[cols="1,1,1", options="header"]
|===
|型|形式|例
|date|yyyy-MM-dd|"2013-08-30"
|time|HH:mm:ss|"14:00:00"
|datetime|long値（UTCミリ秒）|1377842646073
|===

=== AdminConsole
* 日付項目の表示 +
AdminConsole上の日付項目の出力は汎用画面同様、テナントローカルに設定されたロケール、タイムゾーンで表示されます。

* EntityデータのExport/Import +
<<../support/index.adoc#tools_entityexplorer,EntityExplorer>>や<<../support/index.adoc#tools_packaging,Packaging>>のように、EntityのデータのExport/Importに使用されるCSVの日付項目のフォーマット、タイムゾーンは固定です。
システムデフォルトのロケール、タイムゾーンが使用されます。
+
以下の固定形式になっています。
+
[cols="1,1,1", options="header"]
|===
|型|FormatStyle(SimpleDateFormat)|出力例
|DateTimeProperty|yyyy-MM-dd HH:mm:ss.SSSXXX|2012-03-28 10:25:49.000+09:00
|DateProperty|yyyy-MM-dd|2012-03-28
|TimeProperty|HH:mm:ss|10:25:49
|===
+
ロケールに依存する出力形式の差異を上記のように書式を固定して回避します。
DateTimeのTimeZoneについてはエクスポートするテナント側のTimeZone設定値を利用してエクスポート時にCSVに出力します。
インポート時はCSVに出力されたTimeZone値(上の例では+09:00)をもとにTimeStamp型に変換を行います。

=== 環境設定/設定ファイル
iPLAssを動作させる環境におけるロケール、タイムゾーンに関する事項を以下に示します。

* システムデフォルトの統一 +
システムデフォルトのLocale/TimezoneはjavaVM、RDB（のセッション）で統一するものとします。
Oracle/postgresqlでは、自動的にjavaVMのロケール/タイムゾーンが設定されますが、MySQLの場合は、明示的に設定する必要あります。

* iPLAss上で適用可能な言語、ロケールの定義 +
適用可能な言語、ロケールはmtp-service-config.xml上に定義しています。
追加が必要な場合は<<../../serviceconfig/index.adoc#I18nService,org.iplass.mtp.impl.i18n.I18nService>>を変更してください。
