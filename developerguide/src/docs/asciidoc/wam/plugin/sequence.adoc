[[wampluginsequence]]
=== 処理フロー

WAMプラグインモジュールは、サイトコンテンツへのアクセスをフックし、WAMモジュールとHTTP連携して認証・認可の処理を行います。 +
以下に `Apache` のWAMプラグインモジュール実装における、認証・認可処理の流れとエラー時のステータスコードを示します。`Apache` 以外の実装も概ね同様のフローで処理が行われます。 +

==== 認証・認可処理の流れ

.未認証時アクセス～ログイン画面まで
image::images/wam_sequence1.png[]

. ユーザーが管理対象サイトのコンテンツにアクセスします。
. Apacheがコンテンツ生成処理を実行する前に、WAMプラグインモジュールの認証・認可ロジックをフックします。
. サイトコンテンツ閲覧時のアクセスURLが、設定上、参照制限をかけるパスとして設定されている場合、WAMモジュールに閲覧権限の有無を問い合わせます (WAMモジュールの許可APIへリクエスト)。
. 閲覧権限チェックの問い合わせ結果を返却します。認証済みの場合には、ユーザー情報も併せて返却されます（ユーザー情報の返却有無や返却される情報は、WAMプラグインモジュールの設定に依存します）。
. 認証済みかつ、ユーザー情報が返却された場合、元のHTTPリクエストヘッダにユーザー情報を付加します。
. 閲覧権限チェックの問い合わせ結果に応じて、以下の画面遷移を行います。
** 未認証の場合 : ログインページへリダイレクト
** 認証済みの場合 :  元のリクエストに対するコンテンツを応答
** 認証済みで権限がない場合 : 権限エラーページへリダイレクト
** その他 : エラーとして、状況に応じたステータスコードをApacheコアモジュールに渡します。通常のコンテンツ処理や後続のApacheモジュール(PHP等)の処理は実行されません。
+
.ログイン画面～コンテンツへのアクセスまで
image::images/wam_sequence2.png[]
+
. ユーザーがログイン画面でID、パスワードを入力します。
. ログインに成功すると、管理対象サイトのWAMモジュール用URLパス(`manageSite > authCallbackUrl`)へリダイレクトされます。
. WAMモジュールにアクセストークン( = iPLAss上のセッションID)の払出しをリクエストします(WAMモジュールのトークンAPIへリクエスト)。⑧のリダイレクト時にクエリパラメータにセットされた認可コード、WAMプラグインモジュールに設定した管理対象サイトのサイトID、サイトシークレットがパラメータとしてWAMモジュールに送信されます。
. WAMモジュールからWAMプラグインモジュールにアクセストークン( = iPLAss上のセッションID)が返却されます。このアクセストークンが管理対象サイト側ドメインのCookieへと格納され、以降、WAMモジュールへの閲覧権限チェックリクエスト時にCookieとして送信するセッションIDとして使用されます。
. 元のコンテンツURLへリダイレクトします。 再度②～⑤の処理が発生しますが、アクセストークン( = iPLAss上のセッションID)がCookieとして送信され、認証済みセッションとして扱われます。

==== エラー時ステータスコード

WAMモジュールの許可API(permission)、トークンAPI(token)の返却結果によっては、WAMモジュールからApacheにエラーのステータスコードを指示します。 +
その結果、コンテンツ処理が中断されてエラーページが表示されます。以下、ステータスコード及び想定される状況です。

[cols="1,1,10", options="header"]
|===
|上記番号 |ステータスコード |状況

.2+|⑥|400|WAMプラグインモジュールからWAMモジュールの許可APIへ不正な形式でリクエストしています。 +
WAMプラグインモジュールとWAMモジュールのバージョン間の不整合などが原因として考えられます。
|503|WAMモジュールの許可APIから正常な応答を得られていません。iPLAssサーバーやDB、ネットワークの障害等が考えられます。

.2+|⑪|403|CSRFトークンのチェックに失敗しています。Cookieに異常がないか、サーバーのスティッキーセッションが機能しているか確認してください。
|503|WAMモジュールのトークンAPIから正常な応答を得られていません。iPLAssサーバーやDB、ネットワークの障害等が考えられます。
|===
