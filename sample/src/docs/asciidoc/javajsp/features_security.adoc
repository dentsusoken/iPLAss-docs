
[[Java_Jsp_Security]]
=== セキュリティ対策

.ここで作成する機能について
画面、処理、ともにオレンジ色の部分を例にセキュリティ対策を解説していきます。

image::../images/sample-ec_fullcustomize_flow2.png[align=left]

.セキュリティ対策について
ここでは会員登録を例としてiPLAssで利用できる以下のセキュリティ対策について説明します。 +
 +
・ エスケープ機能　　XSS対策 ： ユーザーの入力内容を正常に画面表示させる +
・ TokenCheck機能　　CSRF対策/トランザクション重複起動対策 ： 画面表示時に正常な画面遷移が行われているかをチェックする +
 +
会員登録処理の中でそれぞれの機能は下記のように利用されます。

* エスケープの導入 +
Templateの作成 +
入力された値を出力する会員情報確認画面にて、該当箇所に `${m:esc()}` エスケープを導入する。
+
[cols="1,2",options="header"]
|===
|表示名|Template名
|会員情報確認画面|samples/ec01/member/confirmMemberInfo
|===
+
[source,jsp]
----
<%@ taglib prefix="m" uri="http://iplass.org/tags/mtp"%> <1>
----------------------------------------以上略----------------------------------------
		<div class="card col-12 bg-light">
			<div class="card-body">
				<div class="row mt-3 border-bottom">
					<div class="col-12 col-md-4">
						<span class="text-muted font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.userId')}</span>
					</div>
					<div class="col-12 col-md-8">${m:esc(userBean.userId)}</div>
				</div>
				<div class="row mt-3 border-bottom">
					<div class="col-12 col-md-4">
						<span class="text-muted  font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.registConfirm.fullName')}</span>
					</div>
					<div class="col-12 col-md-4">
						<span class="text-muted  font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.familyName')}</span>
						&nbsp;${m:esc(userBean.familyName)} <2>
					</div>
					<div class="col-12 col-md-4">
						<span class="text-muted  font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.firstName')}</span>
						&nbsp;${m:esc(userBean.firstName)} <2>
					</div>
				</div>
				<% if (Consts.LANGUAGE_JA.equals(TemplateUtil.getLanguage()) || TemplateUtil.getLanguage() == null) { %>
				<div class="row mt-3 border-bottom">
					<div class="col-12 col-md-4">
						<span class="text-muted  font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.registConfirm.fullNameKana')}</span>
					</div>
					<div class="col-12 col-md-4">
						<span class="text-muted  font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.familyNameKana')}</span>
						&nbsp;${m:esc(userBean.familyNameKana)} <2>
					</div>
					<div class="col-12 col-md-4">
						<span class="text-muted  font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.firstNameKana')}</span>
						&nbsp;${m:esc(userBean.firstNameKana)} <2>
					</div>
				</div>
				<% } %>
				<div class="row mt-3 border-bottom">
					<div class="col-12 col-md-4">
						<span class="text-muted  font-weight-bold">${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.mail')}</span>
					</div>
					<div class="col-12 col-md-8">${m:esc(userBean.mail)}</div> <2>
				</div>
			</div>
		</div>
----------------------------------------以下略----------------------------------------
----
<1> iPLAssのJSPタグライブラリ
<2> 今回は出力先がHTML形式であるため全て${m:esc(変数名)}の形式でエスケープを行っている。

* TokenCheckの導入 +
この機能では、iPLAssで実装されている正常に画面遷移してきたことを証明する"Token"というオブジェクトを利用します。不正な画面遷移を禁止するActionでTokenをチェックすることにより、正常な画面遷移が行われたかを判断します。

** Actionの設定 +
不正な画面遷移を禁止するActionでTokenをチェックする設定を行います。
+
[cols="1,2",options="header"]
|===
|表示名|Action名
|会員情報確認アクション|samples/ec01/member/confirmMemberInfo
|===
+
[source,java]
----
@ActionMapping(
		name = "samples/ec01/member/confirmMemberInfo",
		displayName = "会員情報確認アクション",
		privileged = true,
		tokenCheck = @TokenCheck(　<1>
				executeCheck = true,
				consume = true,
				exceptionRollback = true),
		result = {
				@Result(
						status = Constants.CMD_EXEC_ERROR,
						type = Type.TEMPLATE,
						value = "samples/ec01/member/inputMemberInfo"),
				@Result(
						status = Constants.CMD_EXEC_SUCCESS,
						type = Type.TEMPLATE,
						value = "samples/ec01/member/confirmMemberInfo") })
@CommandClass(
		name = "samples/ec01/member/ConfirmMemberInfoCommand",
		displayName = "会員情報確認コマンド")
public class ConfirmMemberInfoCommand implements Command {
----------------------------------------以下略----------------------------------------
----
<1> ActionMapping定義にTokenCheckのアノテーションを利用してます。
+
以下の設定が可能です。
+
|===
h|executeCheck|false チェックを行わない　true チェックを行う
h|useFixedToken|チェック→セッション単位に固定に払いだされるTokenをチェックする
h|consume|true→Tokenは再利用されません。
h|exceptionRollback|チェック→現在のTokenを再設定
|===
+
この設定により直接この画面へ遷移するとエラーページが表示されます。
+
image:images/sample-ec_java-jsp-security-token-error.png[]

** TemplateでTokenを作成 +
不正な画面遷移を禁止するActionへ遷移する画面でTokenを作成します。
+
[cols="1,2",options="header"]
|===
|表示名|Template名
|会員情報入力画面|samples/ec01/member/inputMemberInfo
|===
+
[source,jsp]
----
----------------------------------------以上略----------------------------------------
<%@ taglib prefix="m" uri="http://iplass.org/tags/mtp"%>
<div class="row">
    <div class="col-12">
        <div class="border-top"></div>
        <nav class="breadcrumb all-breadcrumb">
            <a class="breadcrumb-item text-primary" href="${m:tcPath()}/samples/ec01/top">
            	${m:rs('iplass-wtp-messages', 'samples.ec01.all.breadcrumb.home')}
            </a>
            <span class="breadcrumb-item active">
            	${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.title')}
            </span>
        </nav>
    </div>
    <div class="col-12">
        <span class="h4">${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.title')}</span>
        <form class="custom-form mt-3" action="${m:tcPath()}/samples/ec01/member/confirmMemberInfo" method="post">
        <input type="hidden" name="_t" value="${m:token()}"> <1>
        <m:bind bean="${userBean}" mappingResult="${result}">
            <div class="form-group row">
                <div class="col-12">
                    <div>
                        <m:bind prop="userId">
	                        <label for="${name}" class="col-form-label label-hidden">
	                        	${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.userId')}
	                        </label>
	                        <input type="text" class="form-control border rounded input-hint-visible" name="${name}" value="${value}" placeholder="${m:rs('iplass-wtp-messages', 'samples.ec01.member.regist.userId')}">
							<small class="form-text text-danger"><m:errors/></small>
						</m:bind>
                    </div
----------------------------------------以下略----------------------------------------
----
<1> EL関数を利用してTokenを生成します。