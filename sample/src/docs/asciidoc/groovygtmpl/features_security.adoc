[[Groovy_GTmpl_Security]]
=== セキュリティ対策

.ここで作成する機能について
画面、処理、ともにオレンジ色の部分を例にセキュリティ対策を解説していきます。

image::../images/sample-ec_fullcustomize_flow2.png[]

.セキュリティ対策について
ここでは会員登録を例としてiPLAssで利用できる以下のセキュリティ対策について説明します。 + 
 + 
・ エスケープ機能　　XSS対策 ： ユーザーの入力内容を正常に画面表示させる +
・ TokenCheck機能　　CSRF対策/トランザクション重複起動対策 ： 画面表示時に正常な画面遷移が行われているかをチェックする +
 + 
会員登録処理の中でそれぞれの機能は下記のように利用されます。

* ＄エスケープの導入
Templateの作成
入力された値を出力する会員情報確認画面にて、該当箇所に＄エスケープを導入する
+
image::./images/sample-ec_groovy-gtmpl-security-registconfirm.png[]
+
[cols="1,2",options="header"]
|===
|表示名|Template名
|会員情報確認画面|samples/ec01/member/registConfirm
|===
+
[source]
----
----------------------------------------以上略----------------------------------------
    <div class="card col-12 bg-light">
        <div class="card-body">
            <div class="row mt-3 border-bottom">
                <div class="col-12 col-md-4">
                    <span class="text-muted font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.regist.userId")}</span>
                </div>
                <div class="col-12 col-md-8">$h{userBean.userId}</div> <1>
            </div>
            <div class="row mt-3 border-bottom">
                <div class="col-12 col-md-4">
                    <span class="text-muted  font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.registConfirm.fullName")}</span>
                </div>
                <div class="col-12 col-md-3">
                    <span class="text-muted  font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.regist.familyName")}</span>
                    &nbsp;$h{userBean.familyName} <1>
                </div>
                <div class="col-12 col-md-3">
                    <span class="text-muted  font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.regist.firstName")}</span>
                    &nbsp;$h{userBean.firstName} <1>
                </div>
            </div>
            <div class="row mt-3 border-bottom">
                <div class="col-12 col-md-4">
                    <span class="text-muted  font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.registConfirm.fullNameKana")}</span>
                </div>
                <div class="col-12 col-md-3">
                    <span class="text-muted  font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.regist.familyNameKana")}</span>
                    &nbsp;$h{userBean.familyNameKana} <1>
                </div>
                <div class="col-12 col-md-3">
                    <span class="text-muted  font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.regist.firstNameKana")}</span>
                    &nbsp;$h{userBean.firstNameKana} <1>
                </div>
            </div>
            <div class="row mt-3 border-bottom">
                <div class="col-12 col-md-4">
                    <span class="text-muted  font-weight-bold">${msg("samples/ec01/general", "samples.ec01.member.regist.mail")}</span>
                </div>
                <div class="col-12 col-md-8">$h{userBean.mail}</div>
            </div>
        </div>
    </div>
----------------------------------------以下略----------------------------------------
----
<1> 今回は出力先がHTML形式であるため全て `$h{変数名}` の形式でエスケープを行っている。開発者ガイドの<<../../developerguide/customizing/index#_記述形式, 記述形式>>の章を参照してください。

* TokenCheckの導入 +
この機能では、iPLAssで実装されている正常に画面遷移してきたことを証明する"Token"というオブジェクトを利用します。不正な画面遷移を禁止するActionでTokenをチェックすることにより、正常な画面遷移が行われたかを判断します。

** Actionの設定 +
不正な画面遷移を禁止するActionでTokenをチェックする設定を行います。
+
image:images/sample-ec_groovy-gtmpl-security-confirmmemberinfo.png[]
+
[cols="1,2",options="header"]
|===
|表示名|Action名
|会員情報確認アクション|samples/ec01/member/confirmMemberInfo
|===
+
image:images/sample-ec_groovy-gtmpl-security-token-check.png[align=left]
+
|===
h|Token Check|Not Check チェックを行わない　Check チェックを行う
h|use Fixed Token|チェック→セッション単位に固定に払いだされるTokenをチェックする
h|consume a Token |true→Tokenは再利用されません。
h|not change the Token(exception occurs)|チェック→現在のTokenを再設定
|===
+
この設定により直接この画面へ遷移するとエラーページが表示されます。
+
image:images/sample-ec_groovy-gtmpl-security-token-error.png[]

** TemplateでTokenを作成 + 
不正な画面遷移を禁止するActionへ遷移する画面でTokenを作成します。
+
image:images/sample-ec_groovy-gtmpl-security-regist.png[]
+
[cols="1,2",options="header"]
|===
|表示名|Template名
|会員情報確認画面|samples/ec01/member/regist
|===
+
[source]
----
<div class="row">
    <div class="col-12">
        <div class="border-top"></div>
        <nav class="breadcrumb all-breadcrumb">
            <a class="breadcrumb-item text-primary" href="${tcPath()}/samples/ec01/top">
            	${msg("samples/ec01/general", "samples.ec01.all.breadcrumb.home")}
            </a>
            <span class="breadcrumb-item active">
            	${msg("samples/ec01/general", "samples.ec01.member.regist.title")}
            </span>
        </nav>
    </div>
    <div class="col-12">
        <span class="h4">${msg("samples/ec01/general", "samples.ec01.member.regist.title")}</span>
        <form class="custom-form mt-3" action="${tcPath()}/samples/ec01/member/confirmMemberInfo" method="post">
        <input type="hidden" name="_t" value="${token()}"> <1>
        <% bind("bean" : userBean, "mappingResult" : result) { %>
		    <div class="form-group row">
                <div class="col-12">
                    <div>
                        <% bind("prop": "userId") { %>
                        <label for="${name}" class="col-form-label label-hidden">${msg("samples/ec01/general", "samples.ec01.member.regist.userId")}</label>
                        <input type="text" class="form-control border rounded input-hint-visible" name="${name}" value="${value}" placeholder="${msg('samples/ec01/general', 'samples.ec01.member.regist.userId')}">
                        <small class="form-text text-danger"><% errors() %></small>
                        <% } %>
                    </div>
                </div>
----------------------------------------以下略----------------------------------------
----
<1> GroovyTemplate関数を利用してトークンを生成しています。開発者ガイド<<../../developerguide/customizing/index#_groovytemplateの関数,開発者ガイド GroovyTemplateの関数>>の章を参照してください。
