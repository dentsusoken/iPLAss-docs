[[VueJS_WebAPI_ErrorHandler]]
=== 共通エラーハンドラー
Vue.js／WebAPI版のサンプルでは、ルーティングをクライアント側で行っているため、Java／JSP版とGroovy／GroovyTemplate版のサンプルで利用されているErrorUrlSelector機能は使えません。代わりに、`axios` ライブラリのinterceptors機能を利用して同様の機能を実装しています。

[cols="1,2"]
|===
h|ファイル名|/src/main/vue/main.js
|===
[source,javascript]
----
// Axiosの設定
app.config.globalProperties.$http = axios.create({
  headers: { 'X-Requested-With': 'XMLHttpRequest' }　<1>
})
----------------------------------------以上略----------------------------------------
const app = createApp(App, {
  onExpand() {},
  created() {
    // axiosにインターセプターを設定
    this.setupAxiosErrorInterceptors()
  },
  methods: {
    setupAxiosErrorInterceptors() { <2>
      this.$http.interceptors.response.use(
        (response) => {
          return response
        },
        (error) => {
          console.log(error)
          const errorResult = error.response.data
          if (errorResult.exceptionType != null) {
            const exception = errorResult.exceptionType
            this.$router.push({ name: 'genericError', params: { exception: exception } }) <3>
          }
          return Promise.reject(error)
        }
      )
    }
  }
})
----------------------------------------以下略----------------------------------------
----
<1> JSONハイジャックによる攻撃を防ぎます。<<VueJS_WebAPI_Security,セキュリティ対策>>を参照してください。
<2> Vue.js側で `axios` にerror interceptorを登録します。
<3> WebApiでエラーが発生した場合、Vue.js側で `genericError` という名前で登録されたVueコンポーネントに切り替えます。
+
※ `axios` と `Vue Router` ライブラリの使い方については、公式サイトを参照してください。

.動作確認
TokenValidationExceptionが発生した場合、カスタムのテンプレートに遷移すること。

* コンソールに出力されるエラーログは以下の通りです。
+
[source]
----
14:26:53.626 [http-nio-8080-exec-6] DEBUG 25 873   o.i.mtp.impl.auth.AuthContextHolder - check WebApiPermission [webApiName=samples/ec01/inquiry/doInquiry, parameter=org.iplass.mtp.webapi.permission.RequestContextWebApiParameter@1b1910ae] = true (privilegedExecution)
14:26:53.626 [http-nio-8080-exec-6] DEBUG 25 873 samples/ec01/inquiry/RegistInquiryCommand  o.i.m.i.transaction.LocalTransaction - create new Transaction:org.iplass.mtp.impl.transaction.LocalTransaction@791691ea with readOnly=false, stacked:null
14:26:53.626 [http-nio-8080-exec-6] DEBUG 25 873 samples/ec01/inquiry/RegistInquiryCommand  o.iplass.mtp.transaction.Transaction - rollback transaction cause org.iplass.mtp.web.actionmapping.TokenValidationException: 不正な画面遷移が発生しました(一連の登録処理中にブラウザの戻るボタン等を押下してしまいますと正常に処理を継続できない場合があります)。:org.iplass.mtp.impl.transaction.LocalTransaction@791691ea
org.iplass.mtp.web.actionmapping.TokenValidationException: 不正な画面遷移が発生しました(一連の登録処理中にブラウザの戻るボタン等を押下してしまいますと正常に処理を継続できない場合があります)。
	at org.iplass.mtp.impl.webapi.interceptors.TokenInterceptor.tokenError(TokenInterceptor.java:96)
	at org.iplass.mtp.impl.webapi.interceptors.TokenInterceptor.intercept(TokenInterceptor.java:76)
	at org.iplass.mtp.impl.command.InvocationImpl.proceedCommand(InvocationImpl.java:115)
	at org.iplass.mtp.impl.command.interceptors.TransactionInterceptor.lambda$intercept$0(TransactionInterceptor.java:34)
	at org.iplass.mtp.transaction.TransactionManager.doTransaction(TransactionManager.java:114)
	at org.iplass.mtp.transaction.Transaction.with(Transaction.java:303)
	at org.iplass.mtp.impl.command.interceptors.TransactionInterceptor.intercept(TransactionInterceptor.java:33)
	at org.iplass.mtp.impl.command.InvocationImpl.proceedCommand(InvocationImpl.java:115)
----------------------------------------以下略----------------------------------------
----

* クライアントに返却されたレスポンス。
+
[source,json]
----
{"status":"FAILURE","exceptionType":"org.iplass.mtp.web.actionmapping.TokenValidationException","exceptionMessage":"不正な画面遷移が発生しました(一連の登録処理中にブラウザの戻るボタン等を押下してしまいますと正常に処理を継続できない場合があります)。"}
----

* エラー内容表示画面
+
image:images/sample-ec_vuejs-webapi-interceptor-token-error.png[align=left]